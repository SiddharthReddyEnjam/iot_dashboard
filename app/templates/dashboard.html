<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>IoT Real-Time Dashboard</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        color: #333;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
      }

      .header {
        text-align: center;
        margin-bottom: 30px;
        color: white;
      }

      .header h1 {
        font-size: 2.5em;
        margin-bottom: 10px;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
      }

      .status-bar {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 20px;
        margin-bottom: 20px;
        color: white;
      }

      .status-item {
        display: flex;
        align-items: center;
        gap: 8px;
        background: rgba(255, 255, 255, 0.1);
        padding: 8px 16px;
        border-radius: 20px;
        backdrop-filter: blur(10px);
      }

      .status-indicator {
        width: 10px;
        height: 10px;
        background: #4caf50;
        border-radius: 50%;
        animation: pulse 2s infinite;
      }

      @keyframes pulse {
        0% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
        100% {
          opacity: 1;
        }
      }

      .dashboard-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .card {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 15px;
        padding: 20px;
        box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
        backdrop-filter: blur(4px);
        border: 1px solid rgba(255, 255, 255, 0.18);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
      }

      .card:hover {
        transform: translateY(-5px);
        box-shadow: 0 12px 40px rgba(31, 38, 135, 0.5);
      }

      .card-header {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 15px;
        color: #555;
      }

      .card-header i {
        font-size: 1.2em;
        color: #667eea;
      }

      .card-header h3 {
        font-size: 1.1em;
        font-weight: 600;
      }

      .sensor-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        gap: 15px;
      }

      .sensor-item {
        text-align: center;
        padding: 15px;
        background: linear-gradient(145deg, #f0f0f0, #ffffff);
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
      }

      .sensor-item:hover {
        transform: scale(1.05);
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
      }

      .sensor-label {
        font-size: 0.85em;
        color: #666;
        margin-bottom: 5px;
        font-weight: 500;
      }

      .sensor-value {
        font-size: 1.4em;
        font-weight: 700;
        color: #333;
      }

      .sensor-unit {
        font-size: 0.9em;
        color: #888;
        font-weight: normal;
      }

      .chart-container {
        grid-column: 1 / -1;
        height: 400px;
        position: relative;
      }

      .chart-controls {
        display: flex;
        justify-content: center;
        gap: 10px;
        margin-bottom: 15px;
        flex-wrap: wrap;
      }

      .chart-btn {
        padding: 8px 16px;
        border: none;
        border-radius: 20px;
        background: #667eea;
        color: white;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 0.9em;
      }

      .chart-btn:hover {
        background: #5a6fd8;
        transform: translateY(-2px);
      }

      .chart-btn.active {
        background: #4caf50;
      }

      .map-container {
        height: 300px;
        background: #f0f0f0;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #666;
        font-style: italic;
      }

      .controls {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1000;
      }

      .control-btn {
        background: rgba(255, 255, 255, 0.9);
        border: none;
        padding: 10px 15px;
        border-radius: 25px;
        cursor: pointer;
        margin-left: 10px;
        transition: all 0.3s ease;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      .control-btn:hover {
        background: white;
        transform: translateY(-2px);
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
      }

      .timestamp {
        text-align: center;
        color: rgba(255, 255, 255, 0.8);
        font-size: 0.9em;
        margin-top: 20px;
      }

      @media (max-width: 768px) {
        .dashboard-grid {
          grid-template-columns: 1fr;
        }

        .header h1 {
          font-size: 2em;
        }

        .status-bar {
          flex-direction: column;
          gap: 10px;
        }
      }

      /* Color coding for different sensor types */
      .temp-sensor {
        border-left: 4px solid #ff6b6b;
      }
      .humidity-sensor {
        border-left: 4px solid #4ecdc4;
      }
      .co2-sensor {
        border-left: 4px solid #45b7d1;
      }
      .gps-sensor {
        border-left: 4px solid #96ceb4;
      }
      .altitude-sensor {
        border-left: 4px solid #ffeaa7;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1><i class="fas fa-satellite-dish"></i> IoT Real-Time Dashboard</h1>
        <p>Environmental Monitoring & GPS Tracking System</p>
      </div>

      <div class="status-bar">
        <div class="status-item">
          <div class="status-indicator" id="connectionStatus"></div>
          <span id="connectionText">Connected</span>
        </div>
        <div class="status-item">
          <i class="fas fa-database"></i>
          <span id="dataSource">Mock Data</span>
        </div>
        <div class="status-item">
          <i class="fas fa-clock"></i>
          <span id="lastUpdate">--:--:--</span>
        </div>
      </div>

      <div class="controls">
        <button class="control-btn" onclick="toggleDataSource()">
          <i class="fas fa-toggle-on"></i> Toggle Source
        </button>
        <button class="control-btn" onclick="exportData()">
          <i class="fas fa-download"></i> Export
        </button>
      </div>

      <div class="dashboard-grid">
        <!-- Temperature Sensors -->
        <div class="card temp-sensor">
          <div class="card-header">
            <i class="fas fa-thermometer-half"></i>
            <h3>Temperature Sensors</h3>
          </div>
          <div class="sensor-grid">
            <div class="sensor-item">
              <div class="sensor-label">MS5611</div>
              <div class="sensor-value" id="ms5611_temp">--</div>
              <div class="sensor-unit">°C</div>
            </div>
            <div class="sensor-item">
              <div class="sensor-label">DS18B20</div>
              <div class="sensor-value" id="ds18b20_temp">--</div>
              <div class="sensor-unit">°C</div>
            </div>
            <div class="sensor-item">
              <div class="sensor-label">SCD30</div>
              <div class="sensor-value" id="scd30_temp">--</div>
              <div class="sensor-unit">°C</div>
            </div>
          </div>
        </div>

        <!-- Environmental Sensors -->
        <div class="card">
          <div class="card-header">
            <i class="fas fa-leaf"></i>
            <h3>Environmental</h3>
          </div>
          <div class="sensor-grid">
            <div class="sensor-item humidity-sensor">
              <div class="sensor-label">Humidity</div>
              <div class="sensor-value" id="rh">--</div>
              <div class="sensor-unit">%</div>
            </div>
            <div class="sensor-item co2-sensor">
              <div class="sensor-label">CO₂</div>
              <div class="sensor-value" id="co2">--</div>
              <div class="sensor-unit">ppm</div>
            </div>
          </div>
        </div>

        <!-- GPS & Location -->
        <div class="card gps-sensor">
          <div class="card-header">
            <i class="fas fa-map-marker-alt"></i>
            <h3>GPS Location</h3>
          </div>
          <div class="sensor-grid">
            <div class="sensor-item">
              <div class="sensor-label">Latitude</div>
              <div class="sensor-value" id="lat">--</div>
            </div>
            <div class="sensor-item">
              <div class="sensor-label">Longitude</div>
              <div class="sensor-value" id="lon">--</div>
            </div>
            <div class="sensor-item altitude-sensor">
              <div class="sensor-label">Altitude</div>
              <div class="sensor-value" id="alt">--</div>
              <div class="sensor-unit">m</div>
            </div>
          </div>
        </div>

        <!-- Charts -->
        <div class="card chart-container">
          <div class="card-header">
            <i class="fas fa-chart-line"></i>
            <h3>Real-Time Data</h3>
          </div>
          <div class="chart-controls">
            <button class="chart-btn active" onclick="showChart('co2')">
              CO₂
            </button>
            <button class="chart-btn" onclick="showChart('temperature')">
              Temperature
            </button>
            <button class="chart-btn" onclick="showChart('humidity')">
              Humidity
            </button>
            <button class="chart-btn" onclick="showChart('altitude')">
              Altitude
            </button>
          </div>
          <canvas id="dataChart"></canvas>
        </div>
      </div>

      <div class="timestamp">
        Last updated: <span id="timestamp">Never</span>
      </div>
    </div>

    <script>
      const socket = io();
      let currentChart = 'co2';
      let chartData = {
        labels: [],
        co2: [],
        temperature: [],
        humidity: [],
        altitude: [],
      };

      // Chart setup
      const ctx = document.getElementById('dataChart').getContext('2d');
      const chart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: chartData.labels,
          datasets: [
            {
              label: 'CO₂ (ppm)',
              data: chartData.co2,
              borderColor: '#45b7d1',
              backgroundColor: 'rgba(69, 183, 209, 0.1)',
              borderWidth: 3,
              tension: 0.4,
              fill: true,
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: true,
              position: 'top',
            },
          },
          scales: {
            x: {
              display: true,
              grid: { color: 'rgba(0,0,0,0.1)' },
            },
            y: {
              beginAtZero: false,
              grid: { color: 'rgba(0,0,0,0.1)' },
            },
          },
          animation: {
            duration: 500,
          },
        },
      });

      // Socket event handlers
      socket.on('connect', function () {
        document.getElementById('connectionStatus').style.background =
          '#4CAF50';
        document.getElementById('connectionText').textContent = 'Connected';
      });

      socket.on('disconnect', function () {
        document.getElementById('connectionStatus').style.background =
          '#f44336';
        document.getElementById('connectionText').textContent = 'Disconnected';
      });

      socket.on('new_data', function (data) {
        updateDisplay(data);
        updateChart(data);

        const now = new Date(data.timestamp * 1000);
        document.getElementById('timestamp').textContent = now.toLocaleString();
        document.getElementById('lastUpdate').textContent =
          now.toLocaleTimeString();
        document.getElementById('dataSource').textContent =
          data.source === 'mock' ? 'Mock Data' : 'Device Data';
      });

      function updateDisplay(data) {
        document.getElementById('lat').textContent = data.lat.toFixed(6);
        document.getElementById('lon').textContent = data.lon.toFixed(6);
        document.getElementById('alt').textContent = data.alt.toFixed(1);
        document.getElementById('ms5611_temp').textContent =
          data.ms5611_temp.toFixed(1);
        document.getElementById('ds18b20_temp').textContent =
          data.ds18b20_temp.toFixed(1);
        document.getElementById('scd30_temp').textContent =
          data.scd30_temp.toFixed(1);
        document.getElementById('rh').textContent = data.rh.toFixed(1);
        document.getElementById('co2').textContent = data.co2.toFixed(0);
      }

      function updateChart(data) {
        const time = new Date(data.timestamp * 1000).toLocaleTimeString();

        chartData.labels.push(time);
        chartData.co2.push(data.co2);
        chartData.temperature.push(
          (data.ms5611_temp + data.ds18b20_temp + data.scd30_temp) / 3
        );
        chartData.humidity.push(data.rh);
        chartData.altitude.push(data.alt);

        // Keep only last 50 points
        if (chartData.labels.length > 50) {
          chartData.labels.shift();
          chartData.co2.shift();
          chartData.temperature.shift();
          chartData.humidity.shift();
          chartData.altitude.shift();
        }

        updateChartDisplay();
      }

      function showChart(type) {
        currentChart = type;

        // Update button states
        document
          .querySelectorAll('.chart-btn')
          .forEach((btn) => btn.classList.remove('active'));
        event.target.classList.add('active');

        updateChartDisplay();
      }

      function updateChartDisplay() {
        let dataset = chart.data.datasets[0];

        switch (currentChart) {
          case 'co2':
            dataset.label = 'CO₂ (ppm)';
            dataset.data = [...chartData.co2];
            dataset.borderColor = '#45b7d1';
            dataset.backgroundColor = 'rgba(69, 183, 209, 0.1)';
            break;
          case 'temperature':
            dataset.label = 'Average Temperature (°C)';
            dataset.data = [...chartData.temperature];
            dataset.borderColor = '#ff6b6b';
            dataset.backgroundColor = 'rgba(255, 107, 107, 0.1)';
            break;
          case 'humidity':
            dataset.label = 'Humidity (%)';
            dataset.data = [...chartData.humidity];
            dataset.borderColor = '#4ecdc4';
            dataset.backgroundColor = 'rgba(78, 205, 196, 0.1)';
            break;
          case 'altitude':
            dataset.label = 'Altitude (m)';
            dataset.data = [...chartData.altitude];
            dataset.borderColor = '#ffeaa7';
            dataset.backgroundColor = 'rgba(255, 234, 167, 0.1)';
            break;
        }

        chart.data.labels = [...chartData.labels];
        chart.update('none');
      }

      function toggleDataSource() {
        fetch('/api/config', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            use_mock: !document
              .getElementById('dataSource')
              .textContent.includes('Mock'),
          }),
        })
          .then((response) => response.json())
          .then((data) => {
            console.log('Data source toggled:', data.message);
          })
          .catch((error) => {
            console.error('Error toggling data source:', error);
          });
      }

      function exportData() {
        // Create CSV content
        let csv =
          'timestamp,lat,lon,alt,ms5611_temp,ds18b20_temp,scd30_temp,rh,co2\n';

        for (let i = 0; i < chartData.labels.length; i++) {
          csv += `${chartData.labels[i]},`;
          csv += `${chartData.temperature[i]},`; // This would need actual individual sensor data
          csv += `${chartData.humidity[i]},`;
          csv += `${chartData.altitude[i]},`;
          csv += `${chartData.co2[i]}\n`;
        }

        // Download CSV
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `iot_data_${new Date().toISOString().slice(0, 10)}.csv`;
        a.click();
        window.URL.revokeObjectURL(url);
      }

      // Initialize chart with CO2 data
      showChart('co2');
    </script>
  </body>
</html>
