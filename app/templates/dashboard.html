<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>IoT Real-Time Dashboard</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        color: #333;
      }

      .container {
        max-width: 1600px;
        margin: 0 auto;
        padding: 20px;
      }

      .header {
        text-align: center;
        margin-bottom: 30px;
        color: white;
      }

      .header h1 {
        font-size: 2.5em;
        margin-bottom: 10px;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
      }

      .status-bar {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 20px;
        margin-bottom: 20px;
        color: white;
        flex-wrap: wrap;
      }

      .status-item {
        display: flex;
        align-items: center;
        gap: 8px;
        background: rgba(255, 255, 255, 0.1);
        padding: 8px 16px;
        border-radius: 20px;
        backdrop-filter: blur(10px);
      }

      .status-indicator {
        width: 10px;
        height: 10px;
        background: #4caf50;
        border-radius: 50%;
        animation: pulse 2s infinite;
      }

      @keyframes pulse {
        0% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
        100% {
          opacity: 1;
        }
      }

      .controls {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1000;
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }

      .control-btn {
        background: rgba(255, 255, 255, 0.9);
        border: none;
        padding: 10px 15px;
        border-radius: 25px;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        font-size: 0.9em;
      }

      .control-btn:hover {
        background: white;
        transform: translateY(-2px);
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
      }

      .com-config {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 15px;
        padding: 15px;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 15px;
        justify-content: center;
        flex-wrap: wrap;
      }

      .com-input-group {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .com-input {
        padding: 8px 12px;
        border: 2px solid #667eea;
        border-radius: 20px;
        font-size: 1em;
        width: 120px;
        text-align: center;
      }

      .com-btn {
        background: #667eea;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 20px;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .com-btn:hover {
        background: #5a6fd8;
        transform: translateY(-2px);
      }

      /* Main dashboard layout */
      .dashboard-main {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr 2fr;
        gap: 20px;
        margin-bottom: 30px;
      }

      .card {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 15px;
        padding: 20px;
        box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
        backdrop-filter: blur(4px);
        border: 1px solid rgba(255, 255, 255, 0.18);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
      }

      .card:hover {
        transform: translateY(-5px);
        box-shadow: 0 12px 40px rgba(31, 38, 135, 0.5);
      }

      .card-header {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 15px;
        color: #555;
        border-bottom: 2px solid #f0f0f0;
        padding-bottom: 10px;
      }

      .card-header i {
        font-size: 1.2em;
        color: #667eea;
      }

      .card-header h3 {
        font-size: 1.1em;
        font-weight: 600;
      }

      /* Payload Internal Card */
      .payload-internal {
        border-left: 4px solid #667eea;
      }

      .rtc-info {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
        margin-bottom: 15px;
      }

      .info-item {
        background: linear-gradient(145deg, #f8f9ff, #ffffff);
        padding: 12px;
        border-radius: 8px;
        text-align: center;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .info-label {
        font-size: 0.8em;
        color: #666;
        margin-bottom: 5px;
        font-weight: 500;
      }

      .info-value {
        font-size: 1.1em;
        font-weight: 700;
        color: #333;
      }

      .thermal-system {
        background: linear-gradient(145deg, #fff5f5, #ffffff);
        padding: 15px;
        border-radius: 10px;
        border: 2px solid #ff6b6b;
        margin-top: 10px;
      }

      .thermal-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
      }

      .heating-status {
        padding: 4px 12px;
        border-radius: 15px;
        color: white;
        font-weight: bold;
        font-size: 0.9em;
      }

      .heating-on {
        background: #ff6b6b;
      }
      .heating-off {
        background: #4caf50;
      }

      /* Tracking Card */
      .tracking-card {
        border-left: 4px solid #4caf50;
      }

      .gps-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 12px;
      }

      .gps-item {
        background: linear-gradient(145deg, #f0f8f0, #ffffff);
        padding: 12px;
        border-radius: 8px;
        text-align: center;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      /* External Environment Card */
      .external-env {
        border-left: 4px solid #4ecdc4;
      }

      .env-sensors {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
      }

      .sensor-group {
        background: linear-gradient(145deg, #f0f8f8, #ffffff);
        padding: 15px;
        border-radius: 10px;
        border: 1px solid #e0e0e0;
      }

      .sensor-group h4 {
        font-size: 0.9em;
        color: #666;
        margin-bottom: 10px;
        font-weight: 600;
        text-align: center;
        border-bottom: 1px solid #eee;
        padding-bottom: 5px;
      }

      .sensor-reading {
        text-align: center;
        margin-bottom: 8px;
      }

      .sensor-label {
        font-size: 0.75em;
        color: #666;
        margin-bottom: 3px;
      }

      .sensor-value {
        font-size: 1.2em;
        font-weight: 700;
        color: #333;
      }

      .sensor-unit {
        font-size: 0.85em;
        color: #888;
      }

      /* Live Plots Card - Enhanced */
      .live-plots {
        border-left: 4px solid #ffeaa7;
      }

      .chart-controls {
        margin-bottom: 15px;
      }

      .chart-control-section {
        margin-bottom: 12px;
      }

      .chart-control-label {
        font-size: 0.9em;
        font-weight: 600;
        color: #555;
        margin-bottom: 8px;
        display: block;
      }

      .chart-buttons {
        display: flex;
        justify-content: center;
        gap: 8px;
        flex-wrap: wrap;
      }

      .x-axis-buttons {
        display: flex;
        justify-content: center;
        gap: 8px;
        margin-bottom: 8px;
      }

      .chart-btn {
        padding: 6px 12px;
        border: none;
        border-radius: 15px;
        background: #667eea;
        color: white;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 0.8em;
      }

      .chart-btn:hover {
        background: #5a6fd8;
        transform: translateY(-1px);
      }

      .chart-btn.active {
        background: #4caf50;
        box-shadow: 0 2px 8px rgba(76, 175, 80, 0.3);
      }

      .axis-btn {
        background: #ff6b6b;
      }

      .axis-btn:hover {
        background: #ff5252;
      }

      .axis-btn.active {
        background: #e91e63;
      }

      .chart-container {
        height: 320px;
        position: relative;
      }

      /* Map section */
      .map-section {
        margin-top: 30px;
      }

      .map-container {
        height: 400px;
        background: rgba(255, 255, 255, 0.95);
        border-radius: 15px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #666;
        font-style: italic;
        box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
        backdrop-filter: blur(4px);
        border: 1px solid rgba(255, 255, 255, 0.18);
      }

      .timestamp {
        text-align: center;
        color: rgba(255, 255, 255, 0.8);
        font-size: 0.9em;
        margin-top: 20px;
      }

      /* Responsive design */
      @media (max-width: 1200px) {
        .dashboard-main {
          grid-template-columns: 1fr 1fr;
        }
      }

      @media (max-width: 768px) {
        .dashboard-main {
          grid-template-columns: 1fr;
        }

        .header h1 {
          font-size: 2em;
        }

        .status-bar {
          flex-direction: column;
          gap: 10px;
        }

        .controls {
          position: static;
          justify-content: center;
          margin-bottom: 20px;
        }

        .chart-buttons,
        .x-axis-buttons {
          flex-direction: column;
          align-items: center;
        }
      }

      /* Color coding for temperature ranges */
      .temp-cold {
        color: #4ecdc4;
      }
      .temp-normal {
        color: #4caf50;
      }
      .temp-warm {
        color: #ffa726;
      }
      .temp-hot {
        color: #ff6b6b;
      }

      /* Chart info display */
      .chart-info {
        text-align: center;
        margin-bottom: 10px;
        padding: 8px;
        background: rgba(102, 126, 234, 0.1);
        border-radius: 8px;
        font-size: 0.9em;
        color: #555;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1><i class="fas fa-satellite-dish"></i> IoT Real-Time Dashboard</h1>
        <p>
          High Altitude Weather Balloon - Environmental Monitoring & GPS
          Tracking
        </p>
      </div>

      <div class="status-bar">
        <div class="status-item">
          <div class="status-indicator" id="connectionStatus"></div>
          <span id="connectionText">Connected</span>
        </div>
        <div class="status-item">
          <i class="fas fa-database"></i>
          <span id="dataSource">Mock Data</span>
        </div>
        <div class="status-item">
          <i class="fas fa-clock"></i>
          <span id="lastUpdate">--:--:--</span>
        </div>
        <div class="status-item">
          <i class="fas fa-usb"></i>
          <span id="currentPort">COM7</span>
        </div>
      </div>

      <div class="controls">
        <button class="control-btn" onclick="toggleDataSource()">
          <i class="fas fa-toggle-on"></i> Toggle Source
        </button>
        <button class="control-btn" onclick="exportData()">
          <i class="fas fa-download"></i> Export CSV
        </button>
      </div>

      <!-- COM Port Configuration -->
      <div class="com-config">
        <div class="com-input-group">
          <label for="comPort"><i class="fas fa-usb"></i> COM Port:</label>
          <input
            type="text"
            id="comPort"
            class="com-input"
            value="COM7"
            placeholder="COM"
          />
          <button class="com-btn" onclick="updateComPort()">Update</button>
        </div>
        <div class="com-input-group">
          <label for="baudRate"
            ><i class="fas fa-tachometer-alt"></i> Baud Rate:</label
          >
          <select id="baudRate" class="com-input">
            <option value="9600" selected>9600</option>
            <option value="19200">19200</option>
            <option value="38400">38400</option>
            <option value="57600">57600</option>
            <option value="115200">115200</option>
          </select>
          <button class="com-btn" onclick="updateBaudRate()">Update</button>
        </div>
      </div>

      <!-- Main Dashboard Grid -->
      <div class="dashboard-main">
        <!-- Payload Internal -->
        <div class="card payload-internal">
          <div class="card-header">
            <i class="fas fa-microchip"></i>
            <h3>Payload Internal</h3>
          </div>

          <div class="rtc-info">
            <div class="info-item">
              <div class="info-label">RTC Date</div>
              <div class="info-value" id="rtcDate">--/--/----</div>
            </div>
            <div class="info-item">
              <div class="info-label">RTC Time</div>
              <div class="info-value" id="rtcTime">--:--:--</div>
            </div>
          </div>

          <div class="thermal-system">
            <div class="thermal-row">
              <span><strong>Thermal System</strong></span>
              <span class="heating-status" id="heatingStatus">OFF</span>
            </div>
            <div class="thermal-row">
              <span>Temperature:</span>
              <span><strong id="thermalTemp">--</strong> °C</span>
            </div>
            <div class="thermal-row">
              <span>Set Limit:</span>
              <span id="targetRange">--</span>
            </div>
          </div>
        </div>

        <!-- Tracking -->
        <div class="card tracking-card">
          <div class="card-header">
            <i class="fas fa-map-marker-alt"></i>
            <h3>Tracking</h3>
          </div>

          <div class="gps-grid">
            <div class="gps-item">
              <div class="info-label">Latitude</div>
              <div class="info-value" id="latitude">--</div>
            </div>
            <div class="gps-item">
              <div class="info-label">Longitude</div>
              <div class="info-value" id="longitude">--</div>
            </div>
            <div class="gps-item">
              <div class="info-label">Altitude</div>
              <div class="info-value" id="altitude">--</div>
              <div class="sensor-unit">m</div>
            </div>
            <div class="gps-item">
              <div class="info-label">Satellites</div>
              <div class="info-value" id="satellites">--</div>
            </div>
            <div class="gps-item">
              <div class="info-label">UTC Time</div>
              <div class="info-value" id="utcTime">--:--:--</div>
            </div>
          </div>
        </div>

        <!-- External Environment -->
        <div class="card external-env">
          <div class="card-header">
            <i class="fas fa-cloud-sun"></i>
            <h3>External Environment</h3>
          </div>

          <div class="env-sensors">
            <div class="sensor-group">
              <h4>SCD30</h4>
              <div class="sensor-reading">
                <div class="sensor-label">CO₂</div>
                <div class="sensor-value" id="co2">--</div>
                <div class="sensor-unit">ppm</div>
              </div>
              <div class="sensor-reading">
                <div class="sensor-label">Temperature</div>
                <div class="sensor-value" id="scd30Temp">--</div>
                <div class="sensor-unit">°C</div>
              </div>
              <div class="sensor-reading">
                <div class="sensor-label">Humidity</div>
                <div class="sensor-value" id="humidity">--</div>
                <div class="sensor-unit">%</div>
              </div>
            </div>

            <div class="sensor-group">
              <h4>Temperature Sensors</h4>
              <div class="sensor-reading">
                <div class="sensor-label">DS18B20</div>
                <div class="sensor-value" id="ds18b20Temp">--</div>
                <div class="sensor-unit">°C</div>
              </div>
              <div class="sensor-reading">
                <div class="sensor-label">MS5611</div>
                <div class="sensor-value" id="ms5611Temp">--</div>
                <div class="sensor-unit">°C</div>
              </div>
              <div class="sensor-reading">
                <div class="sensor-label">Pressure</div>
                <div class="sensor-value" id="pressure">--</div>
                <div class="sensor-unit">mbar</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Enhanced Live Plots -->
        <div class="card live-plots">
          <div class="card-header">
            <i class="fas fa-chart-line"></i>
            <h3>Live Plots</h3>
          </div>

          <div class="chart-controls">
            <!-- X-Axis Selection -->
            <div class="chart-control-section">
              <span class="chart-control-label">X-Axis:</span>
              <div class="x-axis-buttons">
                <button
                  class="chart-btn axis-btn active"
                  onclick="setXAxis('time')"
                >
                  <i class="fas fa-clock"></i> Time
                </button>
                <button
                  class="chart-btn axis-btn"
                  onclick="setXAxis('altitude')"
                >
                  <i class="fas fa-mountain"></i> Altitude
                </button>
              </div>
            </div>

            <!-- Chart Type Selection -->
            <div class="chart-control-section">
              <span class="chart-control-label">Plot:</span>
              <div class="chart-buttons">
                <button class="chart-btn active" onclick="showChart('co2')">
                  CO₂
                </button>
                <button class="chart-btn" onclick="showChart('ds18b20_temp')">
                  DS18B20 Temp
                </button>
                <button class="chart-btn" onclick="showChart('thermal_temp')">
                  Thermal Temp
                </button>
                <button class="chart-btn" onclick="showChart('humidity')">
                  Humidity
                </button>
                <button class="chart-btn" onclick="showChart('pressure')">
                  Pressure
                </button>
              </div>
            </div>
          </div>

          <!-- Chart Info Display -->
          <div class="chart-info" id="chartInfo">Showing CO₂ vs Time</div>

          <div class="chart-container">
            <canvas id="dataChart"></canvas>
          </div>
        </div>
      </div>

      <!-- Map Section -->
      <div class="map-section">
        <div class="card">
          <div class="card-header">
            <i class="fas fa-globe"></i>
            <h3>GPS Tracking Map</h3>
          </div>
          <div class="map-container" id="mapContainer">
            <div>
              <i
                class="fas fa-map"
                style="font-size: 3em; margin-bottom: 20px; color: #ccc"
              ></i>
              <p>Interactive map will be displayed here</p>
              <p>
                Current Position:
                <span id="currentPosition">Waiting for GPS...</span>
              </p>
            </div>
          </div>
        </div>
      </div>

      <div class="timestamp">
        Last updated: <span id="timestamp">Never</span>
      </div>
    </div>

    <script>
      // Global variables
      let currentChart = 'co2';
      let currentXAxis = 'time';
      let chartData = {
        labels: [], // Time labels
        altitudeLabels: [], // Altitude labels
        co2: [],
        ds18b20_temp: [],
        thermal_temp: [],
        humidity: [],
        pressure: [],
        altitude: [],
        timestamps: [], // Store actual timestamps for calculations
      };

      // Chart configurations for different data types
      const chartConfigs = {
        co2: {
          label: 'CO₂',
          unit: 'ppm',
          color: '#45b7d1',
          backgroundColor: 'rgba(69, 183, 209, 0.1)',
        },
        ds18b20_temp: {
          label: 'DS18B20 Temperature',
          unit: '°C',
          color: '#ff6b6b',
          backgroundColor: 'rgba(255, 107, 107, 0.1)',
        },
        thermal_temp: {
          label: 'Thermal System Temperature',
          unit: '°C',
          color: '#ff9800',
          backgroundColor: 'rgba(255, 152, 0, 0.1)',
        },
        humidity: {
          label: 'Humidity',
          unit: '%',
          color: '#4ecdc4',
          backgroundColor: 'rgba(78, 205, 196, 0.1)',
        },
        pressure: {
          label: 'Pressure',
          unit: 'mbar',
          color: '#ffa726',
          backgroundColor: 'rgba(255, 167, 38, 0.1)',
        },
      };

      // Current configuration
      let currentConfig = {
        comPort: 'COM7',
        baudRate: 9600,
        useMock: true,
      };

      // Chart setup
      const ctx = document.getElementById('dataChart').getContext('2d');
      const chart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: chartData.labels,
          datasets: [
            {
              label: 'CO₂ (ppm)',
              data: chartData.co2,
              borderColor: '#45b7d1',
              backgroundColor: 'rgba(69, 183, 209, 0.1)',
              borderWidth: 2,
              tension: 0.4,
              fill: true,
              pointRadius: 3,
              pointHoverRadius: 6,
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: true,
              position: 'top',
            },
            tooltip: {
              mode: 'index',
              intersect: false,
              callbacks: {
                title: function (tooltipItems) {
                  const index = tooltipItems[0].dataIndex;
                  const timeLabel = chartData.labels[index];
                  const altLabel = chartData.altitudeLabels[index];
                  return `Time: ${timeLabel} | Alt: ${altLabel}m`;
                },
              },
            },
          },
          scales: {
            x: {
              display: true,
              grid: { color: 'rgba(0,0,0,0.1)' },
              title: {
                display: true,
                text: 'Time',
              },
            },
            y: {
              beginAtZero: false,
              grid: { color: 'rgba(0,0,0,0.1)' },
              title: {
                display: true,
                text: 'Value',
              },
            },
          },
          animation: {
            duration: 300,
          },
          interaction: {
            mode: 'index',
            intersect: false,
          },
        },
      });

      // Mock data generator for demonstration
      function generateMockData() {
        const now = new Date();
        const time = now.toLocaleTimeString();

        const mockData = {
          timestamp: now.getTime() / 1000,
          lat: 3325.271972 + (Math.random() - 0.5) * 0.01,
          lon: 11155.243164 + (Math.random() - 0.5) * 0.01,
          alt: 378.0 + (Math.random() - 0.5) * 50,
          satellites: Math.floor(Math.random() * 5) + 7,
          utc_time: time,
          rtc_date: now.toLocaleDateString(),
          rtc_time: time,
          ms5611_temp: 25.95 + (Math.random() - 0.5) * 4,
          pressure: 970.81 + (Math.random() - 0.5) * 20,
          ds18b20_temp: 25.62 + (Math.random() - 0.5) * 3,
          scd30_temp: 26.91 + (Math.random() - 0.5) * 3,
          rh: 39.73 + (Math.random() - 0.5) * 10,
          co2: 732.9 + (Math.random() - 0.5) * 100,
          thermal_temp: 26.04 + (Math.random() - 0.5) * 2,
          heating_status: Math.random() > 0.5 ? 'ON' : 'OFF',
          target_range: '29.4 - 29.6',
          source: currentConfig.useMock ? 'mock' : 'device',
        };

        updateDisplay(mockData);
        updateChart(mockData);

        document.getElementById('timestamp').textContent = now.toLocaleString();
        document.getElementById('lastUpdate').textContent = time;
        document.getElementById('dataSource').textContent =
          mockData.source === 'mock' ? 'Mock Data' : 'Device Data';
      }

      function convertGpsToDecimal(coord) {
        const degrees = Math.floor(coord / 100);
        const minutes = coord - degrees * 100;
        return degrees + minutes / 60;
      }

      function updateDisplay(data) {
        // Convert GPS coordinates
        const latDecimal = convertGpsToDecimal(data.lat);
        const lonDecimal = -convertGpsToDecimal(data.lon); // West longitude

        // Update GPS tracking
        document.getElementById('latitude').textContent = latDecimal.toFixed(6);
        document.getElementById('longitude').textContent =
          lonDecimal.toFixed(6);
        document.getElementById('altitude').textContent = data.alt.toFixed(1);
        document.getElementById('satellites').textContent = data.satellites;
        document.getElementById('utcTime').textContent = data.utc_time;

        // Update payload internal
        document.getElementById('rtcDate').textContent = data.rtc_date;
        document.getElementById('rtcTime').textContent = data.rtc_time;
        document.getElementById('thermalTemp').textContent =
          data.thermal_temp.toFixed(2);
        document.getElementById('targetRange').textContent = data.target_range;

        const heatingStatus = document.getElementById('heatingStatus');
        heatingStatus.textContent = data.heating_status;
        heatingStatus.className =
          'heating-status ' +
          (data.heating_status === 'ON' ? 'heating-on' : 'heating-off');

        // Update environmental sensors
        document.getElementById('co2').textContent = data.co2.toFixed(1);
        document.getElementById('scd30Temp').textContent =
          data.scd30_temp.toFixed(2);
        document.getElementById('humidity').textContent = data.rh.toFixed(1);
        document.getElementById('ds18b20Temp').textContent =
          data.ds18b20_temp.toFixed(2);
        document.getElementById('ms5611Temp').textContent =
          data.ms5611_temp.toFixed(2);
        document.getElementById('pressure').textContent =
          data.pressure.toFixed(2);

        // Update map position
        document.getElementById(
          'currentPosition'
        ).textContent = `${latDecimal.toFixed(4)}°, ${lonDecimal.toFixed(
          4
        )}° @ ${data.alt.toFixed(0)}m`;
      }

      function updateChart(data) {
        const time = new Date(data.timestamp * 1000).toLocaleTimeString();
        const altitude = data.alt.toFixed(1);

        // Add new data points
        chartData.labels.push(time);
        chartData.altitudeLabels.push(altitude);
        chartData.timestamps.push(data.timestamp);
        chartData.co2.push(data.co2);
        chartData.ds18b20_temp.push(data.ds18b20_temp);
        chartData.thermal_temp.push(data.thermal_temp);
        chartData.humidity.push(data.rh);
        chartData.pressure.push(data.pressure);
        chartData.altitude.push(data.alt);

        // Keep only last 50 points for performance
        const maxPoints = 50;
        if (chartData.labels.length > maxPoints) {
          chartData.labels.shift();
          chartData.altitudeLabels.shift();
          chartData.timestamps.shift();
          chartData.co2.shift();
          chartData.ds18b20_temp.shift();
          chartData.thermal_temp.shift();
          chartData.humidity.shift();
          chartData.pressure.shift();
          chartData.altitude.shift();
        }

        updateChartDisplay();
      }

      function setXAxis(axisType) {
        currentXAxis = axisType;

        // Update button states
        document
          .querySelectorAll('.axis-btn')
          .forEach((btn) => btn.classList.remove('active'));
        event.target.classList.add('active');

        updateChartDisplay();
        updateChartInfo();
      }

      function showChart(type) {
        currentChart = type;

        // Update button states
        document
          .querySelectorAll('.chart-buttons .chart-btn')
          .forEach((btn) => btn.classList.remove('active'));
        event.target.classList.add('active');

        updateChartDisplay();
        updateChartInfo();
      }

      function updateChartInfo() {
        const config = chartConfigs[currentChart];
        const xAxisLabel = currentXAxis === 'time' ? 'Time' : 'Altitude (m)';
        const chartInfo = document.getElementById('chartInfo');
        chartInfo.textContent = `Showing ${config.label} vs ${xAxisLabel}`;
      }

      function updateChartDisplay() {
        let dataset = chart.data.datasets[0];
        const config = chartConfigs[currentChart];

        // Update dataset properties
        dataset.label = `${config.label} (${config.unit})`;
        dataset.data = [...chartData[currentChart]];
        dataset.borderColor = config.color;
        dataset.backgroundColor = config.backgroundColor;

        // Update labels based on X-axis selection
        if (currentXAxis === 'time') {
          chart.data.labels = [...chartData.labels];
          chart.options.scales.x.title.text = 'Time';
        } else {
          chart.data.labels = [...chartData.altitudeLabels];
          chart.options.scales.x.title.text = 'Altitude (m)';
        }

        // Update Y-axis title
        chart.options.scales.y.title.text = `${config.label} (${config.unit})`;

        // Update chart
        chart.update('none');
      }

      function updateComPort() {
        const newPort = document.getElementById('comPort').value.trim();
        if (newPort) {
          currentConfig.comPort = newPort;
          document.getElementById('currentPort').textContent = newPort;

          // Send update to backend
          fetch('/api/config', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ serial_port: newPort }),
          })
            .then((response) => response.json())
            .then((data) => {
              console.log('COM port updated:', data.message);
              alert(`COM port updated to ${newPort}`);
            })
            .catch((error) => {
              console.error('Error updating COM port:', error);
              alert('Failed to update COM port');
            });
        }
      }

      function updateBaudRate() {
        const newBaudRate = parseInt(document.getElementById('baudRate').value);
        currentConfig.baudRate = newBaudRate;

        // Send update to backend
        fetch('/api/config', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ baud_rate: newBaudRate }),
        })
          .then((response) => response.json())
          .then((data) => {
            console.log('Baud rate updated:', data.message);
            alert(`Baud rate updated to ${newBaudRate}`);
          })
          .catch((error) => {
            console.error('Error updating baud rate:', error);
            alert('Failed to update baud rate');
          });
      }

      function toggleDataSource() {
        currentConfig.useMock = !currentConfig.useMock;

        fetch('/api/config', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ use_mock: currentConfig.useMock }),
        })
          .then((response) => response.json())
          .then((data) => {
            console.log('Data source toggled:', data.message);
            document.getElementById('dataSource').textContent =
              currentConfig.useMock ? 'Mock Data' : 'Device Data';
          })
          .catch((error) => {
            console.error('Error toggling data source:', error);
          });
      }

      function exportData() {
        // Create comprehensive CSV content
        let csv =
          'timestamp,time_label,altitude,latitude,longitude,satellites,utc_time,rtc_date,rtc_time,';
        csv +=
          'ms5611_temp,ds18b20_temp,thermal_temp,scd30_temp,pressure,humidity,co2,heating_status,target_range\n';

        for (let i = 0; i < chartData.labels.length; i++) {
          const timestamp = chartData.timestamps[i] || '';
          const timeLabel = chartData.labels[i] || '';
          const altitude = chartData.altitude[i] || '';

          csv += `${timestamp},${timeLabel},${altitude},`;
          csv += `,,,,,,`; // GPS and time data placeholders
          csv += `${chartData.ms5611_temp?.[i] || ''},`;
          csv += `${chartData.ds18b20_temp[i] || ''},`;
          csv += `${chartData.thermal_temp[i] || ''},`;
          csv += `,`; // scd30_temp placeholder
          csv += `${chartData.pressure[i] || ''},`;
          csv += `${chartData.humidity[i] || ''},`;
          csv += `${chartData.co2[i] || ''},`;
          csv += `,\n`; // heating_status, target_range placeholders
        }

        // Download CSV
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `weather_balloon_data_${new Date()
          .toISOString()
          .slice(0, 10)}.csv`;
        a.click();
        window.URL.revokeObjectURL(url);
      }

      // Initialize the dashboard
      function initializeDashboard() {
        console.log('Initializing enhanced dashboard...');

        // Set initial status
        document.getElementById('connectionStatus').style.background =
          '#4CAF50';
        document.getElementById('connectionText').textContent = 'Connected';
        document.getElementById('currentPort').textContent =
          currentConfig.comPort;

        // Initialize chart with CO2 data and time axis
        showChart('co2');
        setXAxis('time');
        updateChartInfo();

        // Start mock data generation (replace with WebSocket connection in production)
        if (currentConfig.useMock) {
          setInterval(generateMockData, 1000); // Update every 1 second
        }

        console.log('Enhanced dashboard initialized successfully');
      }

      // WebSocket connection
      const socket = io();

      socket.on('connect', function () {
        document.getElementById('connectionStatus').style.background =
          '#4CAF50';
        document.getElementById('connectionText').textContent = 'Connected';
      });

      socket.on('disconnect', function () {
        document.getElementById('connectionStatus').style.background =
          '#f44336';
        document.getElementById('connectionText').textContent = 'Disconnected';
      });

      socket.on('new_data', function (data) {
        updateDisplay(data);
        updateChart(data);

        const now = new Date(data.timestamp * 1000);
        document.getElementById('timestamp').textContent = now.toLocaleString();
        document.getElementById('lastUpdate').textContent =
          now.toLocaleTimeString();
        document.getElementById('dataSource').textContent =
          data.source === 'mock' ? 'Mock Data' : 'Device Data';
      });

      // Keyboard shortcuts for chart switching
      document.addEventListener('keydown', function (e) {
        if (e.ctrlKey) {
          switch (e.key) {
            case '1':
              e.preventDefault();
              document
                .querySelector('.chart-buttons .chart-btn:nth-child(1)')
                .click();
              break;
            case '2':
              e.preventDefault();
              document
                .querySelector('.chart-buttons .chart-btn:nth-child(2)')
                .click();
              break;
            case '3':
              e.preventDefault();
              document
                .querySelector('.chart-buttons .chart-btn:nth-child(3)')
                .click();
              break;
            case '4':
              e.preventDefault();
              document
                .querySelector('.chart-buttons .chart-btn:nth-child(4)')
                .click();
              break;
            case '5':
              e.preventDefault();
              document
                .querySelector('.chart-buttons .chart-btn:nth-child(5)')
                .click();
              break;
            case 't':
              e.preventDefault();
              document
                .querySelector('.x-axis-buttons .axis-btn:nth-child(1)')
                .click();
              break;
            case 'a':
              e.preventDefault();
              document
                .querySelector('.x-axis-buttons .axis-btn:nth-child(2)')
                .click();
              break;
          }
        }
      });

      // Start the dashboard when page loads
      document.addEventListener('DOMContentLoaded', initializeDashboard);
    </script>
  </body>
</html>
